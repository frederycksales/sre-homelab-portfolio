# Managing the Cluster with `kubectl`

This guide explains how to configure and use `kubectl` on your local machine to securely manage the Kubernetes cluster running in the private lab network.

## Architecture

Direct access to the Kubernetes API server endpoint (`10.10.10.10:6443`) from the local network is not possible due to the isolated network design.

To solve this, we use an **SSH Tunnel**. This involves forwarding a port on your local machine (`localhost`) to the Kubernetes API server port on the control-plane node, using the Proxmox Bastion Host as a secure intermediary.

## Configuration and Usage

The workflow involves two main parts: a one-time setup to fetch the configuration file, and a daily routine to start the tunnel.

### Step 1: One-Time Setup (Fetch `kubeconfig`)

The `kubeconfig` file is generated by K3s on the control-plane node. You only need to fetch it once.

1. **Create the local directory:**
    
    ```bash
    mkdir -p ~/.kube
    ```
    
2. **Copy the file from the server.** This command uses `sudo` on the server to make the file readable, copies it to the user's home directory, and then `scp` retrieves it.
The copied file is now ready for use. **No modifications are needed.**
    
    ```bash
    ssh terraform@10.10.10.10 'sudo cp /etc/rancher/k3s/k3s.yaml ~/k3s.yaml && sudo chown terraform:terraform ~/k3s.yaml'
    scp terraform@10.10.10.10:~/k3s.yaml ~/.kube/k3s-homelab-config
    ```

### Step 2: Daily Workflow

You must perform these actions in your terminal each time you want to manage the cluster.

1. **Start the SSH Tunnel:** Open a dedicated terminal and run the following command. This terminal must remain open while you work.
    
    ```bash
    # This tunnels localhost:6443 to the K8s API server through the Bastion
    ssh -N -L 6443:10.10.10.10:6443 pve-homelab-01
    ```
    
2. **Configure `kubectl`:** Open a **new** terminal. Set the `KUBECONFIG` environment variable to point to your configuration file.
    
    ```bash
    export KUBECONFIG=~/.kube/k3s-homelab-config
    ```
    
3. **Verify Connection:** You can now manage your cluster.
    
    ```bash
    kubectl get nodes
    ```